###################################################
# Created by Astrid Deschenes
# 2015-06-30
###################################################

###################################################
## Test the rjmcmcMethod.R functions
###################################################

### {{{ --- Test setup ---

if(FALSE) {
    library( "RUnit" )
    library( "RJMCMCNucleosomes" )
    library( "GenomicRanges")
}

### }}}

data(reads_demo_01)
data(reads_demo_02)
data(RJMCMC_result)
data(syntheticNucleosomeReads)

DIRECTORY <- system.file("extdata", package = "RJMCMCNucleosomes")

file_001 <- dir(system.file("extdata", package = "RJMCMCNucleosomes"),
                        pattern = "newSeg_1.rds",
                        full.names = TRUE)

file_002 <- dir(system.file("extdata", package = "RJMCMCNucleosomes"),
                        pattern = "newSeg_2.rds",
                        full.names = TRUE)

file_003 <- dir(system.file("extdata", package = "RJMCMCNucleosomes"),
                        pattern = "newSeg_3.rds",
                        full.names = TRUE)


###########################################################
## RJMCMC() function
###########################################################

test.rjmcmc_one_read_forward_and_one_read_reverse <- function() {

    reads <- GRanges(seqnames = Rle(c("chr1"), c(2)),
                            ranges = IRanges(101:102, end = 111:112,
                                        names = head(letters, 2)),
                            strand = Rle(strand(c("-", "+")), c(1, 1)))
    obs <- rjmcmc(forwardandReverseReads = reads,
                    nbrIterations = 210, lambda = 3, kMax = 30,
                    minInterval = 100, maxInterval = 200, minReads = 10,
                    vSeed = 2211)

    exp.k           <- 1
    exp.k_max       <- 1
    exp.mu          <- c(102.161660224199295)

    message     <- paste0(" test.rjmcmc_one_read_forward_and_one_read_reverse() ",
                            "- RJMCMC did not generated expected values")

    checkEqualsNumeric(obs$k, exp.k, msg = message)
    checkEqualsNumeric(obs$k_max, exp.k_max, msg = message)
    checkEqualsNumeric(obs$mu, exp.mu, msg = message)
}


test.rjmcmc_good_result_01 <- function() {

    obs <- rjmcmc(forwardandReverseReads = reads_demo_01,
                        nbrIterations = 100, lambda = 2, kMax = 30,
                        minInterval = 146, maxInterval = 292, minReads = 5,
                        vSeed = 1001)

    exp.k           <- 2
    exp.k_max       <- 2
    exp.mu          <- c(10079.596676761868366, 10145.584928975207731)

    message     <- paste0(" rjmcmc_good_result_01() ",
                        "- RJMCMC did not generated expected values")

    checkEqualsNumeric(obs$k, exp.k, msg = message)
    checkEqualsNumeric(obs$k_max, exp.k_max, msg = message)
    checkEqualsNumeric(obs$mu, exp.mu, msg = message)
}

test.rjmcmc_good_result_02 <- function() {

    obs <- rjmcmc(forwardandReverseReads  = reads_demo_01,
                    nbrIterations = 200, lambda = 3, kMax = 30,
                    minInterval = 146, maxInterval = 292, minReads = 5,
                    vSeed = 201)

    exp.k           <- 1
    exp.k_max       <- 3
    exp.mu          <- c(10055.606842049734041)

    message     <- paste0(" rjmcmc_good_result_02() ",
                        "- RJMCMC did not generated expected values")


    checkEqualsNumeric(obs$k, exp.k, msg = message)
    checkEqualsNumeric(obs$k_max, exp.k_max, msg = message)
    checkEqualsNumeric(obs$mu, exp.mu, msg = message)
}

test.rjmcmc_good_result_03 <- function() {

    obs <- rjmcmc(forwardandReverseReads = reads_demo_01,
                  nbrIterations = 110, lambda = 3, kMax = 30,
                  minInterval = 100, maxInterval = 200, minReads = 335,
                  vSeed = 2011)

    exp.k           <- 2
    exp.k_max       <- 4
    exp.mu          <- c(10057.818967865589002, 10453.014142343075946)

    message     <- paste0(" rjmcmc_good_result_03() ",
                           "- RJMCMC did not generated expected values")

    checkEqualsNumeric(obs$k, exp.k, msg = message)
    checkEqualsNumeric(obs$k_max, exp.k_max, msg = message)
    checkEqualsNumeric(obs$mu, exp.mu, msg = message)
}

test.rjmcmc_good_result_04 <- function() {

    obs <- rjmcmc(forwardandReverseReads = reads_demo_01,
                  nbrIterations = 210, lambda = 3, kMax = 30,
                  minInterval = 100, maxInterval = 200, minReads = 10,
                  vSeed = 2211)

    exp.k           <- 1
    exp.k_max       <- 2
    exp.mu          <- c(10077.161153993813059)

    message     <- paste0(" test.rjmcmc_good_result_04() ",
                          "- RJMCMC did not generated expected values")

    checkEqualsNumeric(obs$k, exp.k, msg = message)
    checkEqualsNumeric(obs$k_max, exp.k_max, msg = message)
    checkEqualsNumeric(obs$mu, exp.mu, msg = message)
}


###########################################################
## mergeAllRDSFilesFromDirectory() function
###########################################################

test.mergeAllRDSFilesFromDirectory_notExisting <- function() {

    dir_01 <- "/toto1/toto2/toto3/toto4/toto5/"
    dir_02 <- "/toto5/toto4/toto3/toto2/toto1/"

    dir <- NULL
    if (!file.exists(dir_01)) {
        dir <- dir_01
    } else {
        if (!file.exists(dir_02)) {
            dir <- dir_02
        }
    }

    if (!is.null(dir)) {
        obs <- tryCatch(mergeAllRDSFilesFromDirectory(dir),
                    error=conditionMessage)
        exp <- paste0("The directory \'", dir,
                  "\' does not exist.")
        message <- paste0(" test.mergeResultFilesInDirectory_notExisting() ",
                      "- A not existing directory did not generated ",
                      "expected message.")
        checkEquals(obs, exp, msg = message)
    }
}

test.mergeAllRDSFilesFromDirectory_good <- function() {

    obs <- mergeAllRDSFilesFromDirectory(DIRECTORY)
    exp <- list()
    exp$k <- 16
    exp$mu <- c(10092.474777629515302, 10242.340786347993344,
                10410.315021756090573, 10546.628207912892321,
                11134.263941022001745, 11244.139414670189581,
                11380.302471258171863, 11412.657313642583176,
                11578.516646129490255, 11868.408425173787691,
                12058.054137626086231, 12235.422415610730241,
                12276.903444548192056, 12412.604063330700228,
                12473.443670263422973, 12585.175197400152683)

    class(exp) <- "rjmcmcNucleosomesMerge"

    message <- paste0(" test.mergeAllRDSFilesFromDirectory_good() ",
                      "- The mergeAllRDSFilesFromDirectory() did not generated ",
                      "expected output.")

    checkEquals(obs, exp, msg = message)
}


###########################################################
## mergeRDSFiles() function
###########################################################

test.mergeRDSFiles_notExisting <- function() {
    file_01 <- "/toto1/toto2/toto3/toto4/toto5/improbable_file_01335320111.RDS"
    file_02 <- "/toto5/toto4/toto3/toto2/toto1/improbable_file_01335320111.RDS"

    fileName <- array(dim = c(0))
    if (!file.exists(file_01)) {
        fileName <- c(file_01)
    }
    if (!file.exists(file_02)) {
        fileName <- c(fileName, file_02)
    }

    if (length(fileName) > 0) {
        obs <- tryCatch(mergeRDSFiles(fileName),
                        error=conditionMessage)
        exp <- paste0("The file \'", fileName[1],
                      "\' does not exist.")
        message <- paste0(" test.mergeRDSFiles_notExisting() ",
                          "- A not existing file did not generated ",
                          "expected message.")
        checkEquals(obs, exp, msg = message)
    }
}

test.mergeRDSFiles_good <- function() {

    files <- c(file_001, file_002, file_003)

    obs <- mergeRDSFiles(files)
    exp <- list()
    exp$k <- 16
    exp$mu <- c(10092.474777629515302, 10242.340786347993344,
                10410.315021756090573, 10546.628207912892321,
                11134.263941022001745, 11244.139414670189581,
                11380.302471258171863, 11412.657313642583176,
                11578.516646129490255, 11868.408425173787691,
                12058.054137626086231, 12235.422415610730241,
                12276.903444548192056, 12412.604063330700228,
                12473.443670263422973, 12585.175197400152683)

    class(exp) <- "rjmcmcNucleosomesMerge"

    message <- paste0(" test.mergeRDSFiles_good() ",
                      "- The mergeRDSFiles() did not generated ",
                      "expected output.")

    checkEquals(obs, exp, msg = message)
}


###########################################################
## postTreatment() function
###########################################################

test.postTreatment_good_01 <- function() {

    obs <- postTreatment(forwardandReverseReads  = reads_demo_02,
                              resultRJMCMC = RJMCMC_result,
                              extendingSize = 20,
                              chrLength = 80000)

    exp <- c(10076.947481311099182, 10241.462264150943156,
             10676.973012005168130)

    message <- paste0(" test.postTreatment_good_01() ",
                      "- posTreatment() did not generated expected result.")

    checkEquals(obs, exp, msg = message)
}

###########################################################
## segmentation() function
###########################################################

test.segmentation_good_01 <- function() {

    sampleGRanges <- GRanges(seqnames = syntheticNucleosomeReads$dataIP$chr,
                    ranges = IRanges(start = syntheticNucleosomeReads$dataIP$start,
                    end = syntheticNucleosomeReads$dataIP$end),
                    strand = syntheticNucleosomeReads$dataIP$strand)

    obs <- segmentation(sampleGRanges, zeta =  147, delta = 20, maxLength = 20000)

    message <- paste0(" test.segmentation_good_01() ",
                      "- segmentation() did not generated expected result.")

    exp.len = 3
    exp.01.len = 10504
    exp.02.len = 11818
    exp.03.len = 9686

    checkTrue(is.list(obs), ms = message)
    checkEquals(length(obs), exp.len, ms = message)
    checkEquals(length(obs[[1]]), exp.01.len, ms = message)
    checkTrue(is(obs[[1]],"GRanges"), ms = message)
    checkEquals(length(obs[[2]]), exp.02.len, ms = message)
    checkTrue(is(obs[[2]],"GRanges"), ms = message)
    checkEquals(length(obs[[3]]), exp.03.len, ms = message)
    checkTrue(is(obs[[3]],"GRanges"), ms = message)
}

test.segmentation_good_02  <- function() {

    sampleGRanges <- GRanges(seqnames = syntheticNucleosomeReads$dataIP$chr,
                    ranges = IRanges(start = syntheticNucleosomeReads$dataIP$start,
                            end = syntheticNucleosomeReads$dataIP$end),
                            strand = syntheticNucleosomeReads$dataIP$strand)

    obs <- segmentation(sampleGRanges, zeta =  142, delta = 40,
                            maxLength = 15000)

    message <- paste0(" test.segmentation_good_02() ",
                        "- segmentation() did not generated expected result.")

    exp.len = 4
    exp.01.len = 7972
    exp.02.len = 8496
    exp.03.len = 9362
    exp.04.len = 6390

    checkTrue(is.list(obs), ms = message)
    checkEquals(length(obs), exp.len, ms = message)
    checkEquals(length(obs[[1]]), exp.01.len, ms = message)
    checkTrue(is(obs[[1]],"GRanges"), ms = message)
    checkEquals(length(obs[[2]]), exp.02.len, ms = message)
    checkTrue(is(obs[[2]],"GRanges"), ms = message)
    checkEquals(length(obs[[3]]), exp.03.len, ms = message)
    checkTrue(is(obs[[3]],"GRanges"), ms = message)
}


###########################################################
## rjmcmcCHR() function
###########################################################

test.rjmcmcCHR_good_01 <- function() {
    tryCatch({

            reads <- GRanges(syntheticNucleosomeReads$dataIP[1:500,])
            obs <- rjmcmcCHR(forwardandReverseReads = reads,
                        zeta = 147, delta = 50, maxLength = 1200,
                        dirOut = "rjmcmcCHR_good_01",
                        nbrIterations = 1000, lambda = 3, kMax = 30,
                        minInterval = 146, maxInterval = 292, minReads = 5,
                        vSeed = 10113, nbCores = 2, saveAsRDS = FALSE)
            message <- paste0(" test.rjmcmcCHR_good_01() ",
                        "- rjmcmcCHR() did not generated expected result.")
            exp.k <- 2
            exp.kPost <- 1
            exp.mu <- c(1081.739501947609369, 1193.472696571378037)
            exp.muPost <- c(1187.924603174603135)
            checkTrue(is.list(obs), ms = message)
            checkEquals(obs$k, exp.k, ms = message)
            checkEquals(obs$kPost, exp.kPost, ms = message)
            checkEquals(obs$mu, exp.mu, ms = message)
        }, finally = {
            if (dir.exists("rjmcmcCHR_good_01")) {
                unlink("rjmcmcCHR_good_01", recursive = TRUE, force = FALSE)
            }
        }
    )
    ## Double check
    if (dir.exists("rjmcmcCHR_good_01")) {
        unlink("rjmcmcCHR_good_01", recursive = TRUE, force = FALSE)
    }
}
